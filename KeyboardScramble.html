<!DOCTYPE html>
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="keywords" content="qwerty,dvorak,colemak,keyboard,game,javascript">
<meta http-equiv="expires" content="0">
<title>Bad Keyboard</title>

<style>
.title {
	color:#777;
	font:3em "times new roman",serif;
	line-height:0.8em;
	vertical-align:center;
	padding:0px 10px;
}
.help {
	color:#666;
	font:italic 0.9em arial,sans-serif;
	vertical-align:top;
}
select {
	font:italic 0.9em arial,sans-serif;
	color:#666;
}
#progress {
	color:#666;
	font:1em "deja vu","lucida console",monospace;
}
#keyboard {
	position:relative;
}
.key {
	background-color:#777;
	border:8px outset #888;
	position:absolute;
	display:block;
	width:33px;
	height:44px;
	padding:2px 5px;
	color:white;
	font:24px Arial;
}
.key_down {
	background-color:#777;
	border:8px inset #888;
	position:absolute;
	display:block;
	width:33px;
	height:44px;
	padding:2px 5px;
	color:white;
	font:24px Arial;
}
.key_correct {
	background-color:#675;
	border:8px outset #786;
	position:absolute;
	display:block;
	width:33px;
	height:44px;
	padding:2px 5px;
	color:white;
	font:24px Arial;
}
.key_wrong {
	background-color:#764;
	border:8px outset #875;
	position:absolute;
	display:block;
	width:33px;
	height:44px;
	padding:2px 5px;
	color:white;
	font:24px Arial;
}
.bump {
	position:absolute;
	display:block;
	text-align:center;
	width:59px;
	height:37px;
	color:white;
	font:24px Arial;
}
</style>

<script type="text/javascript">

//TODO inline event handlers may be bad practice, there seems to be element.on("click", function() {...}). 
//TODO use === for comparison, and use null.
//TODO initialize variables.
//TODO check game start.
//TODO conversion from tabs to spaces and back.
//TODO is rowOffsetNorm a good name?

var startTime;
var badKeyCount = -1;//number of misplaced keys, -1 if game has not started.

var moves;
var keyDown;
var resultHighlights = '';//keys that have been highlighted in any way (green if wrong became right, red if right became wrong).

var letterPatt = /^[A-Z]{1}$/;
var layouts = {
		QWERTY : [{start :  0, keys: 'QWERTYUIOP'},
						{start : 0, keys : 'ASDFGHJKL'},
						{start : 1, keys : 'ZXCVBNM'}],
		Dvorak : [{start :  3, keys: 'PYFGCRL'},
						{start : 0, keys : 'AOEUIDHTNS'},
						{start : 2, keys : 'QJKXBMWVZ'}],
		Colemak : [{start :  0, keys: 'QWFPGJLUY'},
						{start : 0, keys : 'ARSTDHNEIO'},
						{start : 1, keys : 'ZXCVBKM'}]
};
var hardware = {
	keyWidth : 60,
	keyHeight : 65,
	rowOffsetNorm : [0.25, 0.5, 0.0],
	rowOffset : function(row) {
		return this.keyWidth * this.rowOffsetNorm[row];
	},
	bumpY : function() {return 1.4 * this.keyHeight;},
	bumpFX : function() {return 3.5 * this.keyWidth;},
	bumpJX : function() {return 6.5 * this.keyWidth;}
}

function keyPressed(e) {
	if (e.altKey || e.ctrlKey || e.metaKey || e.shiftKey) {
		return true;
	}
	var keyNow = String.fromCharCode(e.which || e.keyCode);//IE9/Firefox/Chrome/Opera/Safari || IE8 and earlier
	if (letterPatt.test(keyNow)) {
		processLetter(keyNow);
		return false;//if layout selection has focus, pressing "D" does not select Dvorak.
	}
	return true;
}

function processLetter(keyNow) {
	if (badKeyCount == -1) {
		scrambleAndStart();
	}
	if (!keyDown) {
		clearResultHighlights();
		keyDown = keyNow;
		document.getElementById(keyDown).setAttribute('class', 'key_down');
	} else if (keyNow == keyDown) {
		document.getElementById(keyDown).setAttribute('class', 'key');
		keyDown = '';
	} else {
		var keyDownContent = document.getElementById(keyDown).innerHTML;
		var keyNowContent = document.getElementById(keyNow).innerHTML;
		highlightMoveResult(keyNow, keyNowContent, keyDownContent);
		highlightMoveResult(keyDown, keyDownContent, keyNowContent);
		document.getElementById(keyNow).innerHTML = keyDownContent;
		document.getElementById(keyDown).innerHTML = keyNowContent;
		keyDown = '';
		++moves;
	}
}

function clearResultHighlights() {
	for (i = 0; i < resultHighlights.length; ++i) {
		document.getElementById(resultHighlights.charAt(i)).setAttribute('class', 'key');
	}
}
function highlightMoveResult(key, content, otherContent) {
	if (otherContent == key) {
		--badKeyCount;
		resultHighlights += key;
		document.getElementById(key).setAttribute('class', 'key_correct');
	} else if (content == key) {
		++badKeyCount;
		resultHighlights += key;
		document.getElementById(key).setAttribute('class', 'key_wrong');
	} else {
		document.getElementById(key).setAttribute('class', 'key');
	}
}
function scrambleAndStart() {//neither scramble type no longer works with an odd number of keys.
	var sel = document.getElementById('scramble_select');
	var scramble_type = sel.options[sel.selectedIndex].value;
	if (scramble_type === 'single') {
		scrambleSingleKeys();
	} else if (scramble_type === 'pair') {
		scrambleKeyPairs();
	}
	badKeyCount = getAllKeys().length;
	moves = 0;
	startTime = new Date().getTime();
	updateProgress();
}
function scrambleSingleKeys() {
	var allKeys = getAllKeys();
	var leftKeys = allKeys;
	var tmpKeys;
	var key;
	for (i = 0; i < allKeys.length; ++i) {
		//tmpKeys is leftKeys except the correct allKeys key
		tmpKeys = leftKeys.replace(allKeys.charAt(i), '');
		//bad key for allKeys.charAt(i) is selected from among tmpKeys
		key = tmpKeys.charAt(Math.floor(Math.random() * tmpKeys.length));
		//selected key is removed from among leftKeys
		leftKeys = leftKeys.replace(key, '');
		document.getElementById(key).innerHTML = allKeys.charAt(i);//TODO Uncaught TypeError: Cannot set property 'innerHTML' of null
	}
}
function scrambleKeyPairs() {
	var leftKeys = getAllKeys();
	var key1;
	var key2;
	while (leftKeys.length > 0) {
		key1 = leftKeys.charAt(Math.floor(Math.random() * leftKeys.length));
		leftKeys = leftKeys.replace(key1, '');
		key2 = leftKeys.charAt(Math.floor(Math.random() * leftKeys.length));
		leftKeys = leftKeys.replace(key2, '');
		document.getElementById(key1).innerHTML = key2;
		document.getElementById(key2).innerHTML = key1;
	}
}
function getAllKeys() {
	var result = '';
	layouts['QWERTY'].forEach(function(x) {
		result += x['keys'];
	});
	return result;
}

function updateProgress() {
	var time = new Date().getTime() - startTime;//seems to work ok even when time passes midnight.
	var sec = Math.floor(time % 60000 / 1000);
	var min = Math.floor((time - sec * 1000) / 60000);
	if (sec < 10) {
		sec = '0' + sec;
	}
	if (badKeyCount == -1) {
		clearResultHighlights();
		document.getElementById('progress').innerHTML = 'Press a letter key on keyboard to start a new game.<br>&nbsp;';
		return;
	} else if (badKeyCount == 0) {
		clearResultHighlights();
		document.getElementById("progress").innerHTML = 'Excellent! Arranging keys took ' + min + ':' + sec + ' and ' + moves +
				' moves.<br/>Press a letter key on keyboard to start a new game.';
		badKeyCount = -1;
		return;
	}
	document.getElementById("progress").innerHTML = '&nbsp;<br>Time: ' + min + ':' + sec + '; misplaced: ' + badKeyCount + "; moves: " + moves + ';';
	setTimeout('updateProgress()', 100);//this suspicious looking line just calls the function once, no need to panic. 
}

function setKeyboard() {
	keyDown = '';
	var sel = document.getElementById('keyboard_select');
	var kbrd = sel.options[sel.selectedIndex].value;
	drawKeyboard(layouts[kbrd]);
	badKeyCount = -1;
}
function drawKeyboard(layout) {
	var kbrd = '';
	for (var i = 0; i < layout.length; ++i) {
		kbrd += drawRow(layout[i], hardware.rowOffset(i), i * hardware['keyHeight']);
	}
	kbrd += bumpText();
	document.getElementById('keyboard').innerHTML = kbrd;
}
function drawRow(row, x, y) {
	var result = '';
	for (var i = 0; i < row['keys'].length; ++i) {
		result += drawKey(row['keys'].charAt(i), x + (row['start'] + i) * hardware['keyWidth'], y);
	}
	return result;
}
function drawKey(key, x, y) {
	return '<span id="' + key + '" class="key" style="left:' + x + 'px;top:' + y + 'px;">' + key + '</span>';
}
function bumpText() {
	var bumpY = hardware.bumpY();
	return '<span class="bump" style="left:' + hardware.bumpFX() + 'px;top:' + bumpY + 'px;">_</span>' +
			'<span class="bump" style="left:' + hardware.bumpJX() + 'px;top:' + bumpY + 'px;">_</span>';
}

</script>
</head>
<body onkeydown="return keyPressed(event);" onload="setKeyboard();">
<h1 class="title">Keyboard Scramble touch typing game</h1>
<p class="help">Press two keys on keyboard to exchange keys.<br>
Objective is to arrange keys as your keyboard.<br>
Keyboard:
<select id="keyboard_select" onchange="setKeyboard();">
	<option value="QWERTY">QWERTY</option>
	<option value="Dvorak">Dvorak</option>
	<option value="Colemak">Colemak</option>
</select>
Scramble:
<select id="scramble_select" onchange="setKeyboard();">
	<option value="single">single</option>
	<option value="pair">pair</option>
</select><br>
</p>
<p id="progress">Press a letter key on keyboard to start a new game.<br>&nbsp;</p>
<div id="keyboard"><p>JavaScript seems to be disabled. Cannot draw keyboard.</p></div>
</body>
</html>